name: Test CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests and Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—ã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã‚’å¯èƒ½ã«

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.1" # hardhat.ymlã¨åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: SOLIDITY_COVERAGE=true npx hardhat coverage
        env:
          NODE_OPTIONS: "--max-old-space-size=4096" # ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’ç·©å’Œ

      - name: Generate coverage badge
        run: |
          # â”€â”€ ç·è¡Œæ•°ã¨ã‚«ãƒãƒ¼ãƒ‰è¡Œæ•°ã‚’å…¨ä½“ã‹ã‚‰é›†è¨ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          TOTAL_LINES=$(awk -F: '/^LF:/ {sum+=$2} END {print sum+0}' coverage/lcov.info)
          COVERED_LINES=$(awk -F: '/^LH:/ {sum+=$2} END {print sum+0}' coverage/lcov.info)

          echo "Total Lines   : ${TOTAL_LINES}"
          echo "Covered Lines : ${COVERED_LINES}"

          # â”€â”€ ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã‚’è¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "$TOTAL_LINES" -eq 0 ]; then
            PERCENTAGE_INT=0
          else
            # scale=2 ã§å°‘æ•°ç¬¬2ä½ã¾ã§è¨ˆç®—ã—ã€printf ã§å››æ¨äº”å…¥
            PERCENTAGE=$(echo "scale=2; 100 * ${COVERED_LINES} / ${TOTAL_LINES}" | bc)
            PERCENTAGE_INT=$(printf "%.0f" "$PERCENTAGE")
          fi

          echo "Coverage Percentage: ${PERCENTAGE_INT}%"
          echo "COVERAGE_PERCENTAGE=${PERCENTAGE_INT}" >> $GITHUB_ENV

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unittests
          name: codecov-umbrella
          verbose: true

      - name: Comment PR with Coverage Info
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ ğŸ“Š

            ç¾åœ¨ã®ã‚«ãƒãƒ¬ãƒƒã‚¸: ${{ env.COVERAGE_PERCENTAGE }}%

            è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯ [Codecov](${{ steps.codecov.outputs.url }}) ã§ç¢ºèªã§ãã¾ã™ã€‚
